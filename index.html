<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>PASOVART YÃ¶netim Paneli</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f0f4f8;--card:#fff;--sb:#1e293b;--sb2:#0f172a;
  --acc:#3b82f6;--acc2:#60a5fa;
  --txt:#1e293b;--txt2:#475569;--txt3:#94a3b8;
  --bdr:#f1f5f9;--bdr2:#e2e8f0;
  --grn:#10b981;--grn-bg:#ecfdf5;
  --red:#ef4444;--red-bg:#fef2f2;--red-l:#fee2e2;
  --amb:#f59e0b;--amb-bg:#fffbeb;
  --pur:#7c3aed;--pur-bg:#ede9fe;
  --blu:#0284c7;--blu-bg:#e0f2fe;
  --sh:0 2px 14px rgba(0,0,0,.07);
  --fn:'DM Sans',system-ui,sans-serif;
  --sb-width: 250px;
}
html,body{height:100%;font-family:var(--fn);background:var(--bg);color:var(--txt)}

/* â”€â”€â”€ APP SHELL â”€â”€â”€ */
.app{display:flex;height:100vh;overflow:hidden}

/* â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â• */
.sb{
  width:var(--sb-width);flex-shrink:0;
  background:linear-gradient(180deg,var(--sb),var(--sb2));
  color:#fff;display:flex;flex-direction:column;
  box-shadow:2px 0 12px rgba(0,0,0,.12);
  position:relative;z-index:20;transition:transform .3s ease;
}
.sb-logo{
  padding:24px 20px 20px;
  border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;align-items:center;gap:12px;
}
.sb-logo-icon{
  width:42px;height:42px;border-radius:12px;
  background:linear-gradient(135deg,#2563eb,#60a5fa);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 3px 10px rgba(37,99,235,.35);
}
.sb-logo-txt strong{font-size:18px;font-weight:800;letter-spacing:-.4px;display:block}
.sb-logo-txt em{font-size:10px;color:rgba(255,255,255,.4);font-style:normal;font-weight:500}
.sb-nav{flex:1;padding:14px 12px;overflow-y:auto}

.nav-item{
  width:100%;display:flex;align-items:center;gap:11px;
  padding:11px 14px;border-radius:10px;border:none;
  background:transparent;color:rgba(255,255,255,.52);
  font:500 14px/1 var(--fn);cursor:pointer;
  transition:all .18s;margin-bottom:3px;position:relative;
  text-align:left;text-decoration:none;
}
.nav-item:hover{background:rgba(255,255,255,.08);color:rgba(255,255,255,.88)}
.nav-item.active{background:rgba(59,130,246,.2);color:var(--acc2);font-weight:700}
.nav-item.active::after{
  content:'';position:absolute;right:14px;top:50%;transform:translateY(-50%);
  width:7px;height:7px;border-radius:50%;background:var(--acc2);
}
.nav-item svg{flex-shrink:0;width:19px;height:19px}

/* Submenu Logic */
.submenu{
  max-height: 0;overflow: hidden;transition: max-height 0.3s ease;
  padding-left: 20px;
}
.nav-item.has-sub.open + .submenu { max-height: 200px; }
.nav-item.has-sub::before{
  content:'';position:absolute;right:14px;top:50%;transform:translateY(-50%) rotate(0deg);
  width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;
  border-top:5px solid rgba(255,255,255,.52);transition:transform .2s;
}
.nav-item.has-sub.open::before{transform:translateY(-50%) rotate(180deg)}

.sb-footer{
  padding:16px 20px;
  border-top:1px solid rgba(255,255,255,.07);
  font-size:11px;color:rgba(255,255,255,.25);
  display:flex;justify-content:space-between;align-items:center;
}
.sb-status{display:flex;align-items:center;gap:6px}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--grn)}
.status-dot.offline{background:#94a3b8}
.status-dot.connecting{background:var(--amb);animation:pulse 1.2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â• */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;position:relative}
.hdr{
  background:var(--card);padding:12px 20px;
  display:flex;justify-content:space-between;align-items:center;
  border-bottom:1px solid var(--bdr);flex-shrink:0;
  box-shadow:0 1px 4px rgba(0,0,0,.04);
}
.hdr-left{display:flex;align-items:center;gap:15px}
.menu-btn{display:none;background:none;border:none;cursor:pointer;color:var(--txt)}
.hdr-search{
  display:flex;align-items:center;gap:8px;
  background:#f8fafc;border-radius:10px;padding:9px 15px;
}
.hdr-search input{
  border:none;outline:none;background:transparent;
  font:400 14px var(--fn);color:var(--txt2);width:180px;
}
.hdr-right{display:flex;align-items:center;gap:14px}
.hdr-greet{font-size:13px;color:var(--txt3)}
.hdr-avatar{
  width:38px;height:38px;border-radius:10px;
  background:linear-gradient(135deg,#2563eb,#60a5fa);
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:800;font-size:15px;
}
.content{flex:1;overflow-y:auto;padding:26px 28px;position:relative}

/* â”€â”€â”€ PAGES & UI ELEMENTS â”€â”€â”€ */
.pg{display:none;animation:fadeUp .28s ease}.pg.on{display:block}
.ph{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
.ph h2{font-size:21px;font-weight:800;color:var(--txt)}

.btn{
  display:inline-flex;align-items:center;gap:6px;
  border:none;border-radius:10px;padding:9px 18px;
  font:600 14px var(--fn);cursor:pointer;
  transition:transform .12s,box-shadow .12s;white-space:nowrap;
}
.btn:active{transform:scale(.96)}
.btn-p{background:linear-gradient(135deg,#1e40af,var(--acc));color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.3)}
.btn-g{background:#f1f5f9;color:var(--txt2)}.btn-g:hover{background:var(--bdr2)}
.btn-d{background:var(--red-l);color:var(--red)}.btn-d:hover{background:#fecaca}
.btn-e{background:#eef2ff;color:#4f46e5}.btn-e:hover{background:#e0e7ff}
.btn-sm{padding:5px 9px;font-size:12px;border-radius:8px}

.card{background:var(--card);border-radius:14px;box-shadow:var(--sh);border:1px solid var(--bdr)}
.card-p{padding:22px}
.badge{display:inline-block;padding:3px 11px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap}
.b-upcoming{background:var(--blu-bg);color:var(--blu)}
.b-done,.b-completed,.b-active{background:var(--grn-bg);color:var(--grn)}
.b-inprogress,.b-pending{background:var(--amb-bg);color:var(--amb)}
.b-todo{background:var(--pur-bg);color:var(--pur)}

.stat-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:14px;margin-bottom:22px}
.stat{padding:18px 19px;display:flex;align-items:center;gap:15px}
.stat-ico{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.stat-lbl{font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.stat-val{font-size:21px;font-weight:800;margin-top:2px}

.tbl-wrap{border-radius:14px;border:1px solid var(--bdr);box-shadow:var(--sh);overflow-x:auto}
table{width:100%;border-collapse:collapse;background:var(--card)}
thead tr{background:#f8fafc}
th{padding:11px 14px;text-align:left;font-size:11px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--bdr);white-space:nowrap}
td{padding:12px 14px;font-size:13px;color:var(--txt2);border-bottom:1px solid #fafafa;white-space:nowrap}
tr:last-child td{border-bottom:none}

.cl-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:15px}
.cl-card{padding:19px}
.cl-head{display:flex;justify-content:space-between;align-items:flex-start}
.cl-ava{width:43px;height:43px;border-radius:12px;background:linear-gradient(135deg,#dbeafe,#bfdbfe);display:flex;align-items:center;justify-content:center}

/* â”€â”€â”€ MOBILE MODIFICATIONS â”€â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:15;opacity:0;pointer-events:none;transition:opacity .3s}
.overlay.active{opacity:1;pointer-events:all}
@media (max-width: 768px) {
  .app{flex-direction:column}
  .sb{position:fixed;top:0;left:0;bottom:0;transform:translateX(-100%)}
  .sb.active{transform:translateX(0)}
  .menu-btn{display:block}
  .content{padding:15px}
  .hdr-search{display:none}
}

/* â”€â”€â”€ MODAL & TOAST â”€â”€â”€ */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.38);backdrop-filter:blur(5px);z-index:999;display:none;align-items:center;justify-content:center}
.mo.on{display:flex}
.mo-box{background:#fff;border-radius:16px;width:90%;max-width:470px;max-height:90vh;overflow-y:auto;padding:30px;box-shadow:0 30px 70px rgba(0,0,0,.2)}
.mo-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px}
.mo-cls{border:none;background:#f1f5f9;border-radius:8px;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fg{margin-bottom:15px}
.fg label{display:block;font-size:13px;font-weight:600;color:var(--txt2);margin-bottom:5px}
.fg input,.fg select,.fg textarea{width:100%;padding:9px 13px;border:1.5px solid var(--bdr2);border-radius:10px;font:400 14px var(--fn);background:#fafafa;color:var(--txt);outline:none;transition:border .2s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--acc);background:#fff}
.fg textarea{resize:vertical;min-height:60px}
.fr{display:flex;gap:11px}.fr .fg{flex:1}
.f-sub{width:100%;padding:11px;margin-top:6px;font-size:15px}
.toast{position:fixed;bottom:24px;right:24px;z-index:1001;background:var(--txt);color:#fff;padding:12px 20px;border-radius:12px;font:500 14px var(--fn);opacity:0;transform:translateY(12px);transition:all .3s;pointer-events:none;max-width:320px}
.toast.on{opacity:1;transform:translateY(0)}
.toast.success{background:var(--grn)}
.toast.error{background:var(--red)}

/* Login Screen */
.login-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--sb),var(--sb2));z-index:9999;display:flex;align-items:center;justify-content:center}
.login-box{background:#fff;border-radius:20px;padding:40px;width:90%;max-width:400px;box-shadow:0 30px 80px rgba(0,0,0,.3)}
.login-logo{text-align:center;margin-bottom:30px}
.login-logo-icon{width:60px;height:60px;border-radius:16px;background:linear-gradient(135deg,#2563eb,#60a5fa);display:inline-flex;align-items:center;justify-content:center;box-shadow:0 5px 15px rgba(37,99,235,.4);margin-bottom:12px}

@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
</style>
</head>
<body>

<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      </div>
      <strong>PASOVART</strong>
      <em>YÃ¶netici GiriÅŸi</em>
    </div>
    <div class="fg"><label>KullanÄ±cÄ± AdÄ±</label><input type="text" id="loginUser" placeholder="KullanÄ±cÄ± adÄ±nÄ±z"/></div>
    <div class="fg"><label>Åifre</label><input type="password" id="loginPass" placeholder="Åifreniz" onkeypress="if(event.key==='Enter')doLogin()"/></div>
    <button class="btn btn-p f-sub" onclick="doLogin()">GiriÅŸ Yap</button>
    <div id="loginError" style="color:var(--red);font-size:12px;margin-top:10px;text-align:center;display:none"></div>
  </div>
</div>

<div class="app" style="display:none" id="mainApp">
<div class="overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<aside class="sb" id="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-icon">
      <svg width="21" height="21" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
    </div>
    <div class="sb-logo-txt"><strong>PASOVART</strong><em>YÃ¶netim Paneli</em></div>
  </div>
  <nav class="sb-nav">
    <button class="nav-item active" data-tab="dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Ana Ã–zet
    </button>
    <button class="nav-item" data-tab="sessions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Ã‡ekimler
    </button>
    <button class="nav-item" data-tab="clients">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/><circle cx="17" cy="9" r="2.5"/><path d="M23 21v-1.5a3 3 0 0 0-3-3h-.5"/></svg>
      MÃ¼ÅŸteriler
    </button>
    <button class="nav-item" data-tab="client-auth">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
      MÃ¼ÅŸteri GiriÅŸleri
    </button>
    
    <button class="nav-item" data-tab="finance">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Gelir / Gider
    </button>
    
    <button class="nav-item has-sub" onclick="toggleSub(event)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      DÃ¼kkanlar
    </button>
    <div class="submenu">
      <button class="nav-item" data-tab="store-corlu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>
        Ã‡orlu
      </button>
      <button class="nav-item" data-tab="store-ergene">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>
        Ergene
      </button>
    </div>
  </nav>
  <div class="sb-footer">
    <span>PASOVART v2.2</span>
    <div class="sb-status">
      <div class="status-dot connecting" id="statusDot"></div>
      <span id="statusTxt">BaÄŸlanÄ±yorâ€¦</span>
    </div>
  </div>
</aside>

<div class="main">
  <header class="hdr">
    <div class="hdr-left">
      <button class="menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1e293b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="hdr-search">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" placeholder="Aramaâ€¦" />
      </div>
    </div>
    <div class="hdr-right">
      <span class="hdr-greet">HoÅŸ geldin, PASOVART ğŸ‘‹</span>
      <div class="hdr-avatar">F</div>
    </div>
  </header>
  <div class="content">
    <div class="pg on" id="pg-dashboard"></div>
    <div class="pg"    id="pg-sessions"></div>
    <div class="pg"    id="pg-clients"></div>
    <div class="pg"    id="pg-client-auth"></div> <div class="pg"    id="pg-finance"></div>
    <div class="pg"    id="pg-store-corlu"></div>
    <div class="pg"    id="pg-store-ergene"></div>
  </div>
</div>
</div>

<div class="mo" id="mo" onclick="if(event.target===this)closeModal()">
  <div class="mo-box">
    <div class="mo-hd">
      <h3 id="moTitle">â€“</h3>
      <button class="mo-cls" onclick="closeModal()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div id="moBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE KONFIGÃœRASYONU
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const firebaseConfig = {
  apiKey: "AIzaSyC82ZVx7sf6evT4zs3b5qoQ6H7eXTrf4Ng",
  authDomain: "pasovartpanel.firebaseapp.com",
  projectId: "pasovartpanel",
  storageBucket: "pasovartpanel.firebasestorage.app",
  messagingSenderId: "1031606727169",
  appId: "1:1031606727169:web:bde71345525d0ec7c90600",
  measurementId: "G-GTR6KPH1CL"
};

/* â•â•â•â•â•â•â• GÄ°RÄ°Å (LOGIN) SÄ°STEMÄ° â•â•â•â•â•â•â• */
const USERS = {
  'ferdi': { pass: '123456', name: 'Ferdi' },
  'eren': { pass: '123456', name: 'Eren' },
  'muharrem': { pass: '123456', name: 'Muharrem' }
};
let currentUser = null;

window.doLogin = function() {
  const user = document.getElementById('loginUser').value.toLowerCase();
  const pass = document.getElementById('loginPass').value;
  const err = document.getElementById('loginError');
  if (USERS[user] && USERS[user].pass === pass) {
    currentUser = { username: user, name: USERS[user].name };
    localStorage.setItem('pf_currentUser', JSON.stringify(currentUser));
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
    document.querySelector('.hdr-greet').textContent = `HoÅŸ geldin, ${currentUser.name} ğŸ‘‹`;
    document.querySelector('.hdr-avatar').textContent = currentUser.name[0].toUpperCase();
  } else {
    err.textContent = 'KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!';
    err.style.display = 'block';
  }
}
function checkLogin() {
  const saved = localStorage.getItem('pf_currentUser');
  if (saved) {
    currentUser = JSON.parse(saved);
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
    document.querySelector('.hdr-greet').textContent = `HoÅŸ geldin, ${currentUser.name} ğŸ‘‹`;
    document.querySelector('.hdr-avatar').textContent = currentUser.name[0].toUpperCase();
  }
}

/* â•â•â•â•â•â•â• FIREBASE INIT â•â•â•â•â•â•â• */
let db = null;
let useFirebase = false;
let _doc, _collection, _setDoc, _deleteDoc, _getDocs;

async function initFirebase() {
  try {
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js');
    const {
      getFirestore, doc: docFn, collection: colFn, setDoc: setDocFn, deleteDoc: deleteDocFn, getDocs: getDocsFn
    } = await import('https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js');

    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    _doc = docFn; _collection = colFn; _setDoc = setDocFn; _deleteDoc = deleteDocFn; _getDocs = getDocsFn;
    
    useFirebase = true;
    setStatus('online', 'Ã‡evrimiÃ§i');
    await loadAllFromFirebase();
  } catch (e) {
    console.warn('Firebase baÄŸlantÄ± hata:', e);
    useFirebase = false;
    setStatus('offline', 'Ã‡evrimdÄ±ÅŸÄ± (yerel)');
    loadAllFromLocal();
  }
  checkLogin();
  render('dashboard');
}

function setStatus(state, txt) {
  const dot = document.getElementById('statusDot');
  dot.className = 'status-dot' + (state === 'online' ? '' : state === 'offline' ? ' offline' : ' connecting');
  document.getElementById('statusTxt').textContent = txt;
}

/* â•â•â•â•â•â•â• DATA HANDLING â•â•â•â•â•â•â• */
let clients=[], sessions=[], expenses=[], incomes=[];

/* Firebase'den TÃ¼m Verileri Ã‡ek */
async function loadAllFromFirebase() {
  clients   = await fbGetAll('clients');
  sessions  = await fbGetAll('sessions');
  expenses  = await fbGetAll('expenses');
  incomes   = await fbGetAll('incomes');
}
async function fbGetAll(col) {
  try { const snap = await _getDocs(_collection(db, col)); return snap.docs.map(d => ({ ...d.data(), _fbId: d.id })); } catch { return []; }
}
async function fbAdd(col, obj) {
  if (!useFirebase) return obj;
  try {
    const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
    const ref = _doc(db, col, id);
    const { _fbId, ...data } = obj;
    await _setDoc(ref, data);
    obj._fbId = id; showToast('Kaydedildi âœ“', 'success');
  } catch(e){ console.warn(e); showToast('Hata - Yerel kaydedildi', 'error'); }
  return obj;
}
async function fbUpdate(col, obj) {
  if (!useFirebase || !obj._fbId) return;
  try { const { _fbId, ...data } = obj; await _setDoc(_doc(db, col, _fbId), data); showToast('GÃ¼ncellendi âœ“', 'success'); } catch(e){ showToast('GÃ¼ncelleme hata', 'error'); }
}
async function fbDelete(col, fbId) {
  if (!useFirebase || !fbId) return;
  try { await _deleteDoc(_doc(db, col, fbId)); showToast('Silindi âœ“', 'success'); } catch(e){ showToast('Silme hata', 'error'); }
}

/* LocalStorage Yedek */
const ld = (k, fb) => { try { const v = localStorage.getItem('pf_' + k); return v ? JSON.parse(v) : fb; } catch { return fb; } };
const sv = () => {
  if (useFirebase) return;
  localStorage.setItem('pf_clients', JSON.stringify(clients));
  localStorage.setItem('pf_sessions', JSON.stringify(sessions));
  localStorage.setItem('pf_expenses', JSON.stringify(expenses));
  localStorage.setItem('pf_incomes', JSON.stringify(incomes));
};
function loadAllFromLocal() {
  clients   = ld('clients', []);
  sessions  = ld('sessions', []);
  expenses  = ld('expenses', []);
  incomes   = ld('incomes', []);
}

/* â•â•â•â•â•â•â• UI HELPERS â•â•â•â•â•â•â• */
const uid = () => Date.now() + (Math.random() * 9999 | 0);
const cn = id => (clients.find(c => c.id == id) || {}).name || 'â€“';
const fm = n => Number(n).toLocaleString('tr-TR');
const I = {
  plus:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
  trash:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>`,
  edit:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
  key:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>`
};

/* â•â•â•â•â•â•â• MOBILE MENÃœ JS â•â•â•â•â•â•â• */
window.toggleSub = function(e) {
  e.preventDefault();
  const btn = e.currentTarget;
  btn.classList.toggle('open');
}
window.toggleSidebar = function() {
  const sb = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sb.classList.toggle('active');
  overlay.classList.toggle('active');
}

/* â•â•â•â•â•â•â• NAVIGATION â•â•â•â•â•â•â• */
let cur = 'dashboard';
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.nav-item').forEach(btn => {
    if (!btn.classList.contains('has-sub')) {
      btn.addEventListener('click', function() {
        if(window.innerWidth <= 768) window.toggleSidebar();
        const tab = this.dataset.tab;
        if(tab) go(tab);
      });
    }
  });
});
function go(k) {
  cur = k;
  document.querySelectorAll('.nav-item').forEach(b => {
    if(!b.classList.contains('has-sub')) b.classList.toggle('active', b.dataset.tab === k);
  });
  document.querySelectorAll('.pg').forEach(p => p.classList.remove('on'));
  const pg = document.getElementById('pg-' + k);
  if(pg) { pg.classList.add('on'); render(k); }
}

/* â•â•â•â•â•â•â• RENDERERS â•â•â•â•â•â•â• */
function render(k) { 
  const pages = { 
    dashboard: rDash, sessions: rSess, clients: rCli, 'client-auth': rCliAuth,
    finance: rFin,
    'store-corlu': () => rStore('corlu'),
    'store-ergene': () => rStore('ergene')
  };
  if(pages[k]) document.getElementById('pg-'+k).innerHTML = pages[k](); 
}

/* --- DASHBOARD --- */
function rDash() {
  const inc = incomes.reduce((a,i)=>a+i.amt,0);
  const exp = expenses.reduce((a,e)=>a+e.amt,0);
  const up = sessions.filter(s=>s.status==='upcoming').sort((a,b)=>new Date(a.date)-new Date(b.date));
  return `
  <div class="stat-grid">
    <div class="card stat"><div class="stat-ico" style="background:#ecfdf5"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg></div><div><div class="stat-lbl">Toplam Gelir</div><div class="stat-val" style="color:#10b981">â‚º${fm(inc)}</div></div></div>
    <div class="card stat"><div class="stat-ico" style="background:#fef2f2"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div><div><div class="stat-lbl">Toplam Gider</div><div class="stat-val" style="color:#ef4444">â‚º${fm(exp)}</div></div></div>
    <div class="card stat"><div class="stat-ico" style="background:#eff6ff"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div><div class="stat-lbl">Net KazanÃ§</div><div class="stat-val" style="color:#3b82f6">â‚º${fm(inc-exp)}</div></div></div>
  </div>
  <div class="card card-p">
    <div class="ph" style="margin-bottom:14px"><h3 style="font-size:16px;font-weight:700">ğŸ“¸ YaklaÅŸan Ã‡ekimler</h3></div>
    ${up.slice(0,5).map(s => { const d=new Date(s.date); return `<div style="display:flex;align-items:center;gap:13px;padding:11px 0;border-bottom:1px solid #f1f5f9">
      <div style="width:46px;height:46px;border-radius:11px;background:linear-gradient(135deg,#dbeafe,#bfdbfe);display:flex;flex-direction:column;align-items:center;justify-content:center;color:#1e40af;font-weight:800;line-height:1"><span style="font-size:16px">${d.getDate()}</span><span style="font-size:9px;color:#3b82f6;text-transform:uppercase">${d.toLocaleString('tr',{month:'short'})}</span></div>
      <div style="flex:1"><div style="font-weight:600;font-size:14px;color:#1e293b">${cn(s.cid)}</div><div style="font-size:12px;color:#94a3b8">${s.pkg}</div></div>
      <div style="font-weight:700;color:#1e40af;font-size:14px">â‚º${fm(s.total)}</div>
    </div>`; }).join('')}
  </div>`;
}

/* --- CLIENT AUTH (Ã–NEMLÄ° KISIM) --- */
function rCliAuth() {
  return `
  <div class="ph"><h2>ğŸ” MÃ¼ÅŸteri GiriÅŸ YÃ¶netimi</h2></div>
  <div class="card card-p">
    <p style="font-size:13px;color:var(--txt2);margin-bottom:15px;line-height:1.6">
      AÅŸaÄŸÄ±daki listeden mÃ¼ÅŸterilerinize <strong>KullanÄ±cÄ± AdÄ±</strong> ve <strong>Åifre</strong> tanÄ±mlayabilirsiniz.
      TanÄ±mladÄ±ÄŸÄ±nÄ±z bu bilgiler Firebase veritabanÄ±na kaydedilir ve mÃ¼ÅŸteriniz kendi panelinden bu bilgilerle giriÅŸ yapar.
    </p>
    <div class="tbl-wrap"><table>
      <thead><tr><th>MÃ¼ÅŸteri AdÄ±</th><th>KullanÄ±cÄ± AdÄ±</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
      <tbody>
        ${clients.map(c => `
          <tr>
            <td style="font-weight:600;color:var(--txt)">${c.name}</td>
            <td>${c.username ? c.username : '<span style="color:var(--txt3);font-style:italic">Belirlenmedi</span>'}</td>
            <td>${c.username ? '<span class="badge b-active">Aktif</span>' : '<span class="badge b-pending">Pasif</span>'}</td>
            <td>
              <button class="btn btn-e btn-sm" onclick="openMo('auth', ${c.id})">
                ${I.key} ${c.username ? 'DÃ¼zenle' : 'GiriÅŸ OluÅŸtur'}
              </button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table></div>
  </div>`;
}

/* --- STORE LOGIC --- */
function rStore(storeCode) {
  const storeName = storeCode === 'corlu' ? 'Ã‡orlu' : 'Ergene';
  const sInc = incomes.filter(i => i.store === storeCode).reduce((a,b)=>a+b.amt,0);
  const sExp = expenses.filter(e => e.store === storeCode).reduce((a,b)=>a+b.amt,0);
  const sItems = [...incomes.filter(i=>i.store===storeCode).map(i=>({...i, type:'inc'})), ...expenses.filter(e=>e.store===storeCode).map(e=>({...e, type:'exp'}))].sort((a,b)=>new Date(b.date)-new Date(a.date));

  return `
  <div class="ph"><h2>ğŸª ${storeName} Åubesi</h2></div>
  <div class="stat-grid">
    <div class="card stat"><div class="stat-ico" style="background:#ecfdf5"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg></div><div><div class="stat-lbl">${storeName} Gelir</div><div class="stat-val" style="color:#10b981">â‚º${fm(sInc)}</div></div></div>
    <div class="card stat"><div class="stat-ico" style="background:#fef2f2"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div><div><div class="stat-lbl">${storeName} Gider</div><div class="stat-val" style="color:#ef4444">â‚º${fm(sExp)}</div></div></div>
  </div>
  <div class="card card-p">
    <h3 style="font-size:16px;font-weight:700;margin-bottom:15px">Hareketler</h3>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Tarih</th><th>AÃ§Ä±klama</th><th>TÃ¼rÃ¼</th><th>Tutar</th></tr></thead>
      <tbody>
        ${sItems.length > 0 ? sItems.map(item => `<tr><td>${item.date}</td><td style="font-weight:600">${item.desc}</td><td>${item.type==='inc'?'<span style="color:var(--grn)">Gelir</span>':'<span style="color:var(--red)">Gider</span>'}</td><td style="font-weight:700">${item.type==='inc'?'+':'-'}â‚º${fm(item.amt)}</td></tr>`).join('') : '<tr><td colspan="4" style="text-align:center;color:var(--txt3)">KayÄ±t yok.</td></tr>'}
      </tbody>
    </table></div>
  </div>`;
}

/* --- FINANCE & STANDARD PAGES --- */
function rFin() {
  const inc = incomes.reduce((a, i) => a + i.amt, 0);
  const exp = expenses.reduce((a, e) => a + e.amt, 0);
  return `
  <div class="ph"><h2>ğŸ’° Gelir / Gider</h2><div style="display:flex;gap:8px"><button class="btn btn-p" onclick="openMo('income')">${I.plus} Gelir Ekle</button><button class="btn btn-p" style="background:linear-gradient(135deg,#dc2626,#ef4444);box-shadow:0 2px 8px rgba(239,68,68,.3)" onclick="openMo('expense')">${I.plus} Gider Ekle</button></div></div>
  <div class="stat-grid" style="grid-template-columns:repeat(auto-fit, minmax(200px, 1fr))">
    <div class="card stat"><div class="stat-ico" style="background:#ecfdf5"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg></div><div><div class="stat-lbl">Toplam Gelir</div><div class="stat-val" style="color:#10b981">â‚º${fm(inc)}</div></div></div>
    <div class="card stat"><div class="stat-ico" style="background:#fef2f2"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div><div><div class="stat-lbl">Toplam Gider</div><div class="stat-val" style="color:#ef4444">â‚º${fm(exp)}</div></div></div>
  </div>`;
}
function rSess() { return `<div class="ph"><h2>ğŸ“· Ã‡ekimler</h2><button class="btn btn-p" onclick="openMo('session')">${I.plus} Yeni</button></div><div class="tbl-wrap"><table><thead><tr><th>MÃ¼ÅŸteri</th><th>Tarih</th><th>Paket</th><th>Tutar</th><th>Ä°ÅŸlem</th></tr></thead><tbody>${sessions.map(s=>`<tr><td style="font-weight:600">${cn(s.cid)}</td><td>${s.date}</td><td>${s.pkg}</td><td>â‚º${fm(s.total)}</td><td style="display:flex;gap:5px"><button class="btn btn-e btn-sm" onclick="openMo('session',${s.id})">${I.edit}</button><button class="btn btn-d btn-sm" onclick="del('session',${s.id})">${I.trash}</button></td></tr>`).join('')}</tbody></table></div>`; }
function rCli() { return `<div class="ph"><h2>ğŸ‘¤ MÃ¼ÅŸteriler</h2><button class="btn btn-p" onclick="openMo('client')">${I.plus} Yeni</button></div><div class="cl-grid">${clients.map(c=>`<div class="card cl-card"><div class="cl-head"><div class="cl-ava">${I.edit}</div><div><div style="font-weight:700">${c.name}</div><div style="font-size:12px">${c.phone}</div></div><button class="btn btn-d btn-sm" onclick="del('client',${c.id})">${I.trash}</button></div></div>`).join('')}</div>`; }

/* â•â•â•â•â•â•â• ACTIONS â•â•â•â•â•â•â• */
window.del = async function(type, id) {
  const map = { session: 'sessions', client: 'clients', expense: 'expenses', income: 'incomes' };
  const col = map[type];
  const item = eval(col).find(x => x.id === id);
  if(useFirebase && item && item._fbId) await fbDelete(col, item._fbId);
  eval(`${col} = ${col}.filter(x => x.id !== ${id})`);
  if(!useFirebase) sv();
  render(cur);
}

/* â•â•â•â•â•â•â• MODALS & FORMS â•â•â•â•â•â•â• */
const moTitles = { session:'Ã‡ekim Ekle', client:'MÃ¼ÅŸteri Ekle', expense:'Gider Ekle', income:'Gelir Ekle', auth:'MÃ¼ÅŸteri GiriÅŸ Bilgileri' };
let _moType = '', _moId = null;

window.openMo = function(type, editId) {
  _moType = type; _moId = editId || null;
  document.getElementById('moTitle').textContent = editId && type!=='auth' ? 'DÃ¼zenle' : moTitles[type];
  document.getElementById('moBody').innerHTML = moForms[type](editId);
  document.getElementById('mo').classList.add('on');
}
window.closeModal = function() { document.getElementById('mo').classList.remove('on'); }
const v = id => (document.getElementById(id) || {}).value || '';

const moForms = {
  // *** AUTH FORM (MÃœÅTERÄ° PANELÄ° Ä°Ã‡Ä°N) ***
  auth: (id) => {
    const c = clients.find(x => x.id === id);
    return `
      <div class="fg"><label>MÃ¼ÅŸteri AdÄ±</label><input type="text" value="${c.name}" disabled style="background:#e2e8f0;font-weight:600"/></div>
      <div style="background:#fffbeb;padding:10px;border-radius:8px;border:1px solid #fcd34d;font-size:12px;color:#92400e;margin-bottom:15px">
        âš ï¸ Buraya gireceÄŸiniz bilgiler ile mÃ¼ÅŸteri kendi panelinden giriÅŸ yapacaktÄ±r.
      </div>
      <div class="fg"><label>KullanÄ±cÄ± AdÄ±</label><input type="text" id="f_user" placeholder="Ã¶rn: ${c.name.toLowerCase().replace(/\s/g,'')}" value="${c.username||''}"/></div>
      <div class="fg"><label>Åifre</label><input type="text" id="f_pass" placeholder="Åifre belirle" value="${c.password||''}"/></div>
      <button class="btn btn-p f-sub" onclick="subAuth(${id})">Bilgileri GÃ¼ncelle & Kaydet</button>
    `;
  },
  session: (id) => {
    const o = id ? sessions.find(s=>s.id===id) : {};
    return `<div class="fg"><label>MÃ¼ÅŸteri</label><select id="f_cid"><option value="">SeÃ§â€¦</option>${clients.map(c=>`<option value="${c.id}" ${o.cid==c.id?'selected':''}>${c.name}</option>`).join('')}</select></div><div class="fr"><div class="fg"><label>Tarih</label><input type="date" id="f_date" value="${o.date||''}"/></div><div class="fg"><label>Tutar</label><input type="number" id="f_total" value="${o.total||''}"/></div></div><div class="fg"><label>Paket</label><input type="text" id="f_pkg" value="${o.pkg||''}"/></div><button class="btn btn-p f-sub" onclick="subSession(${id||0})">Kaydet</button>`;
  },
  client: (id) => `<div class="fg"><label>Ad</label><input type="text" id="f_name"/></div><div class="fg"><label>Tel</label><input type="text" id="f_phone"/></div><button class="btn btn-p f-sub" onclick="subClient(0)">Kaydet</button>`,
  expense: () => `<div class="fg"><label>Tarih</label><input type="date" id="f_date"/></div><div class="fg"><label>AÃ§Ä±klama</label><input type="text" id="f_desc"/></div><div class="fr"><div class="fg"><label>Tutar</label><input type="number" id="f_amt"/></div><div class="fg"><label>Åube</label><select id="f_store"><option value="">Genel</option><option value="corlu">Ã‡orlu</option><option value="ergene">Ergene</option></select></div></div><button class="btn btn-p f-sub" onclick="subExpense(0)">Kaydet</button>`,
  income: () => `<div class="fg"><label>Tarih</label><input type="date" id="f_date"/></div><div class="fg"><label>AÃ§Ä±klama</label><input type="text" id="f_desc"/></div><div class="fr"><div class="fg"><label>Tutar</label><input type="number" id="f_amt"/></div><div class="fg"><label>Åube</label><select id="f_store"><option value="">Genel</option><option value="corlu">Ã‡orlu</option><option value="ergene">Ergene</option></select></div></div><button class="btn btn-p f-sub" onclick="subIncome(0)">Kaydet</button>`
};

/* â•â•â•â•â•â•â• SUBMIT HANDLERS â•â•â•â•â•â•â• */
// MÃœÅTERÄ° GÄ°RÄ°Å BÄ°LGÄ°LERÄ°NÄ° KAYDETME
window.subAuth = async function(id) {
  const c = clients.find(x => x.id === id);
  c.username = v('f_user');
  c.password = v('f_pass');
  // Firebase'deki mevcut mÃ¼ÅŸteri kaydÄ±nÄ± gÃ¼ncelliyoruz
  await persistOne('clients', c);
  closeModal();
  render('client-auth');
}

window.subSession = async function(id) {
  const obj = { id: id||uid(), cid: v('f_cid'), date: v('f_date'), total: Number(v('f_total')), pkg: v('f_pkg'), status:'upcoming' };
  if(id) { const idx=sessions.findIndex(x=>x.id===id); sessions[idx]={...sessions[idx],...obj}; await persistOne('sessions',sessions[idx]); }
  else { sessions.push(obj); await persistOne('sessions',obj,true); }
  closeModal(); render('sessions');
}
window.subClient = async function() {
  const obj = { id: uid(), name: v('f_name'), phone: v('f_phone') };
  clients.push(obj); await persistOne('clients',obj,true); closeModal(); render('clients');
}
window.subExpense = async function() {
  const obj = { id: uid(), date: v('f_date'), desc: v('f_desc'), amt: Number(v('f_amt')), store: v('f_store') };
  expenses.push(obj); await persistOne('expenses',obj,true); closeModal(); render(cur);
}
window.subIncome = async function() {
  const obj = { id: uid(), date: v('f_date'), desc: v('f_desc'), amt: Number(v('f_amt')), store: v('f_store') };
  incomes.push(obj); await persistOne('incomes',obj,true); closeModal(); render(cur);
}

async function persistOne(col, obj, isNew = false) {
  if (useFirebase) { if (isNew || !obj._fbId) await fbAdd(col, obj); else await fbUpdate(col, obj); } 
  else { sv(); showToast('Kaydedildi âœ“', 'success'); }
}

/* â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â• */
let toastTimer;
window.showToast = function(msg, type) {
  const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast on ' + type;
  clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('on'), 2400);
}
initFirebase();

</script>
</body>
</html>
